{% extends 'base.html' %}{% block content %}
<div class="container py-5" style="max-width: 900px; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); color: #333;">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 class="mb-1">{% if post %}Edit Post{% else %}Create New Blog Post{% endif %}</h3>
      <p class="text-muted mb-0 small">Fill in the details below to {% if post %}update{% else %}publish{% endif %} your blog post.</p>
    </div>
    <a href="/blog/" class="btn btn-outline-secondary">Back to Blog</a>
  </div>
  {% if errors %}
  <div class="alert alert-danger"><pre class="mb-0">{{ errors|safe }}</pre></div>
  {% endif %}
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="mb-3">
      <label class="form-label">Title</label>
      {% if post %}
      <input type="text" name="title" class="form-control" value="{{ post.title }}" required>
      {% elif form %}
      <input type="text" name="title" class="form-control" value="{{ form.title }}" required>
      {% else %}
      <input type="text" name="title" class="form-control" value="" required>
      {% endif %}
    </div>
    <div class="mb-3">
      <label class="form-label">Excerpt</label>
      {% if post %}
      <textarea name="excerpt" class="form-control" rows="2">{{ post.excerpt }}</textarea>
      {% elif form %}
      <textarea name="excerpt" class="form-control" rows="2">{{ form.excerpt }}</textarea>
      {% else %}
      <textarea name="excerpt" class="form-control" rows="2"></textarea>
      {% endif %}
    </div>
    <div class="mb-3">
      <label class="form-label">Cover image</label>
      {% if post and post.cover_image %}
      <div class="mb-2"><img src="{{ post.cover_image.url }}" alt="Cover" class="img-fluid rounded border" style="max-height: 200px; object-fit: cover;"></div>
      {% endif %}
      <input type="file" name="cover_image" class="form-control" accept="image/*">
    </div>
    <div class="mb-3">
      <label class="form-label">Content</label>
      {% if post %}
      <textarea name="content" class="form-control" rows="20" placeholder="Write your post here...">{{ post.content }}</textarea>
      {% elif form %}
      <textarea name="content" class="form-control" rows="20" placeholder="Write your post here...">{{ form.content }}</textarea>
      {% else %}
      <textarea name="content" class="form-control" rows="20" placeholder="Write your post here..."></textarea>
      {% endif %}
    </div>
    <div class="mb-3">
      <label class="form-label">Status</label>
      <select name="status" class="form-select">
        <option value="draft" {% if post and post.status == 'draft' %}selected{% endif %}>Draft</option>
        <option value="published" {% if post and post.status == 'published' %}selected{% endif %}>Published</option>
        <option value="archived" {% if post and post.status == 'archived' %}selected{% endif %}>Archived</option>
      </select>
    </div>
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Categories</label>
        <select name="categories" class="form-select" multiple size="6">
          {% for c in categories %}
            <option value="{{ c.id }}" {% if c.id in selected_category_ids %}selected{% endif %}>{{ c.name }}</option>
          {% endfor %}
        </select>
        <div class="form-text">Hold Ctrl/Cmd to select multiple. {% if not categories %}<a href="/admin/blog/category/add/" target="_blank" class="text-decoration-underline">Create your first category</a>{% else %}Optional. <a href="/admin/blog/category/" target="_blank" class="text-decoration-underline">Manage categories</a>{% endif %}</div>
      </div>
      <div class="col-md-6">
        <label class="form-label">Tags (SEO Keywords)</label>
        <select name="tags" class="form-select" multiple size="6">
          {% for t in tags %}
            <option value="{{ t.id }}" {% if t.id in selected_tag_ids %}selected{% endif %}>{{ t.name }}</option>
          {% endfor %}
        </select>
        <div class="form-text">
          <strong>ðŸ’¡ SEO Tip:</strong> Select 5-10 relevant tags. 
          {% if not tags %}
            <a href="/admin/blog/tag/add/" target="_blank" class="text-decoration-underline">Create tags</a> or run <code>python manage.py populate_seo_tags</code>
          {% else %}
            <a href="/admin/blog/tag/" target="_blank" class="text-decoration-underline">Manage tags</a>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="d-flex gap-2 mt-4">
      <button type="submit" class="btn btn-primary">Save Post</button>
      {% if post %}<a class="btn btn-outline-secondary" href="/blog/{{ post.slug }}/">View</a>{% endif %}
    </div>
  </form>
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
  <style>
    #quill-editor { min-height: 440px; }
    .ql-container { min-height: 440px; }
  </style>
  <script>
  (function(){
    function getCookie(name){
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    document.addEventListener('DOMContentLoaded', function(){
      const textarea = document.querySelector('textarea[name="content"]');
      if(!textarea) return;
      if (textarea.dataset.enhanced === '1') return;
      const container = document.createElement('div');
      container.id = 'quill-editor';
      container.className = 'mb-3';
      textarea.parentNode.insertBefore(container, textarea.nextSibling);
      const toolbarOptions = [
        [{ header: [1, 2, 3, false] }],
        ['bold', 'italic', 'underline', 'link'],
        [{ list: 'ordered' }, { list: 'bullet' }],
        ['image'],
        ['clean']
      ];
      const quill = new Quill('#quill-editor', {
        theme: 'snow',
        placeholder: 'Write your post here... (use headings, images, links, lists, etc.)',
        modules: { toolbar: toolbarOptions }
      });
      quill.root.innerHTML = textarea.value || '';
      quill.getModule('toolbar').addHandler('image', function(){
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = function(){
          const file = input.files && input.files[0];
          if(!file) return;
          const formData = new FormData();
          formData.append('upload', file, file.name);
          fetch('/cms/uploads/images/', {
            method: 'POST',
            credentials: 'include',
            headers: { 'X-CSRFToken': getCookie('csrftoken') },
            body: formData
          }).then(r => r.json()).then(json => {
            const url = json && (json.url || json.location);
            if(!url) return;
            const range = quill.getSelection(true) || { index: quill.getLength(), length: 0 };
            quill.insertEmbed(range.index, 'image', url, 'user');
            quill.setSelection(range.index + 1, 0, 'user');
          }).catch(console.error);
        };
        input.click();
      });
      const form = textarea.closest('form');
      if(form){
        textarea.removeAttribute('required');
        form.addEventListener('submit', function(e){
          const html = quill.root.innerHTML.trim();
          const text = quill.getText().trim();
          if (!text && !html.includes('<img')) {
            e.preventDefault();
            alert('Content is required.');
            return false;
          }
          textarea.value = html;
        });
      }
      textarea.style.display = 'none';
      textarea.dataset.enhanced = '1';
    });
  })();
  </script>
</div>
{% endblock %}


