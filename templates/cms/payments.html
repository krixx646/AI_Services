{% extends 'base.html' %}{% load static %}{% block content %}
<div class="container py-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="mb-0 text-white">Payment Management</h3>
    <div class="d-flex gap-2">
      <a href="/cms/bots/" class="btn btn-outline-light btn-sm">Agent Management</a>
      <a href="/blog/" class="btn btn-outline-light btn-sm">Back to Blog</a>
    </div>
  </div>

  <!-- Search and Filter -->
  <div class="card mb-4">
    <div class="card-body">
      <form class="row g-3" method="get">
        <div class="col-md-4">
          <input class="form-control" type="text" name="q" value="{{ q }}" placeholder="Search by email, username, or reference">
        </div>
        <div class="col-md-3">
          <select name="status" class="form-select">
            <option value="">All Statuses</option>
            <option value="pending" {% if filter_status == 'pending' %}selected{% endif %}>Pending</option>
            <option value="success" {% if filter_status == 'success' %}selected{% endif %}>Success</option>
            <option value="failed" {% if filter_status == 'failed' %}selected{% endif %}>Failed</option>
          </select>
        </div>
        <div class="col-md-3">
          <select name="bot_status" class="form-select">
            <option value="">All Agent Statuses</option>
            <option value="pending" {% if filter_bot_status == 'pending' %}selected{% endif %}>Agent Pending</option>
            <option value="processing" {% if filter_bot_status == 'processing' %}selected{% endif %}>Agent Processing</option>
            <option value="ready" {% if filter_bot_status == 'ready' %}selected{% endif %}>Agent Ready</option>
            <option value="failed" {% if filter_bot_status == 'failed' %}selected{% endif %}>Agent Failed</option>
            <option value="none" {% if filter_bot_status == 'none' %}selected{% endif %}>No Agent Yet</option>
          </select>
        </div>
        <div class="col-auto">
          <button class="btn btn-primary" type="submit">Filter</button>
          <a href="/cms/payments/" class="btn btn-outline-secondary">Clear</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Stats Summary -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card bg-success text-white">
        <div class="card-body">
          <h6 class="card-title">Total Success</h6>
          <h3 class="mb-0">{{ stats.success_count }}</h3>
          <small>{{ stats.success_amount }} {{ stats.currency }}</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning text-dark">
        <div class="card-body">
          <h6 class="card-title">Pending</h6>
          <h3 class="mb-0">{{ stats.pending_count }}</h3>
          <small>{{ stats.pending_amount }} {{ stats.currency }}</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-info text-white">
        <div class="card-body">
          <h6 class="card-title">Agents Ready</h6>
          <h3 class="mb-0">{{ stats.bots_ready }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-danger text-white">
        <div class="card-body">
          <h6 class="card-title">Needs Processing</h6>
          <h3 class="mb-0">{{ stats.needs_processing }}</h3>
          <small>Paid but no agent</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Payments Table -->
  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead>
            <tr>
              <th>Student</th>
              <th>Reference</th>
              <th>Amount</th>
              <th>Payment Status</th>
              <th>Agent Status</th>
              <th>Agent Link</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for payment in payments %}
            <tr>
              <td>
                <div class="d-flex align-items-center">
                  {% if payment.student.avatar %}
                  <img src="{{ payment.student.avatar.url }}" alt="" class="rounded-circle me-2" width="32" height="32">
                  {% else %}
                  <div class="rounded-circle bg-secondary text-white d-flex justify-content-center align-items-center me-2" style="width:32px;height:32px;font-size:.8rem;">
                    {{ payment.student.username|slice:":1"|upper }}
                  </div>
                  {% endif %}
                  <div>
                    <div class="fw-bold">{{ payment.student.username }}</div>
                    <small class="text-muted">{{ payment.student.email }}</small>
                  </div>
                </div>
              </td>
              <td>
                <code class="small">{{ payment.reference }}</code>
              </td>
              <td>
                <strong>{{ payment.amount }} {{ payment.currency }}</strong>
              </td>
              <td>
                <form method="post" action="/cms/payments/update-status/" style="display:inline;">
                  {% csrf_token %}
                  <input type="hidden" name="payment_id" value="{{ payment.id }}">
                  <select name="payment_status" class="form-select form-select-sm" onchange="this.form.submit()" style="width: 120px;">
                    <option value="pending" {% if payment.status == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="success" {% if payment.status == 'success' %}selected{% endif %}>Success</option>
                    <option value="failed" {% if payment.status == 'failed' %}selected{% endif %}>Failed</option>
                  </select>
                </form>
              </td>
              <td>
                {% if payment.bot_info %}
                <span class="badge bg-{% if payment.bot_info.status == 'ready' %}success{% elif payment.bot_info.status == 'processing' %}warning{% elif payment.bot_info.status == 'failed' %}danger{% else %}secondary{% endif %}">
                  {{ payment.bot_info.status }}
                </span>
                {% else %}
                <span class="badge bg-light text-dark">No Agent</span>
                {% endif %}
              </td>
              <td>
                {% if payment.bot_info %}
                <form method="post" action="/cms/payments/update-bot/" class="d-flex gap-1">
                  {% csrf_token %}
                  <input type="hidden" name="bot_id" value="{{ payment.bot_info.id }}">
                  <input type="url" name="bot_url" value="{{ payment.bot_info.bot_url }}" class="form-control form-control-sm" placeholder="https://..." style="min-width: 200px;">
                  <button class="btn btn-sm btn-primary" type="submit" title="Save URL">
                    <i class="bi bi-check-lg"></i>
                  </button>
                </form>
                {% else %}
                <form method="post" action="/cms/payments/create-bot/" style="display:inline;">
                  {% csrf_token %}
                  <input type="hidden" name="payment_reference" value="{{ payment.reference }}">
                  <button class="btn btn-sm btn-outline-primary" type="submit">Create Agent</button>
                </form>
                {% endif %}
              </td>
              <td>
                <small class="text-muted">{{ payment.created_at|date:"M d, Y H:i" }}</small>
              </td>
              <td>
                <div class="btn-group btn-group-sm">
                  <a href="/api/payments/receipt/{{ payment.reference }}/" target="_blank" class="btn btn-outline-secondary btn-sm" title="View Receipt">
                    <i class="bi bi-receipt"></i>
                  </a>
                  <a href="https://wa.me/{{ payment.student.phone }}?text=Hi%20{{ payment.student.username }},%20regarding%20your%20payment%20{{ payment.reference }}" target="_blank" class="btn btn-outline-success btn-sm" title="WhatsApp User">
                    <i class="bi bi-whatsapp"></i>
                  </a>
                  <form method="post" action="/cms/payments/delete/" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this payment record? This action cannot be undone.')">
                    {% csrf_token %}
                    <input type="hidden" name="payment_id" value="{{ payment.id }}">
                    <button type="submit" class="btn btn-outline-danger btn-sm" title="Delete Payment">
                      <i class="bi bi-trash"></i>
                    </button>
                  </form>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="8" class="text-center text-muted py-4">No payments found.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination (if needed) -->
      {% if payments|length >= 50 %}
      <div class="text-center mt-3">
        <small class="text-muted">Showing first 50 results. Use filters to narrow down.</small>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

